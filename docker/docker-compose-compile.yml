services:
  llama-qnn-compile:
    platform: linux/x86_64
    image: chraac/llama-cpp-qnn-builder:latest
    environment:
      ANDROID_PLATFORM: android-31
      TARGET_ARCH: arm64-v8a
      BUILD_TYPE: ${BUILD_TYPE}
      HOST_USER_ID: ${HOST_USER_ID}
      OUTPUT_DIR: /mnt/output
      LOCAL_REPO_DIR: '/llama_cpp'
      CMAKE_EXTRA_OPTIONS: '-DBUILD_SHARED_LIBS=off -DGGML_OPENMP=off'
    volumes:
      - ${LLAMA_CPP_REPO}:/mnt/llama_cpp_mount:ro
      - ${OUTPUT_PATH}:/mnt/output:rw
    command: 
      - sh 
      - -c 
      - |
        echo "ANDROID_NDK_HOME: $$ANDROID_NDK_HOME"
        echo "QNN_SDK_PATH: $$QNN_SDK_PATH"
        mkdir -p $$LOCAL_REPO_DIR
        chmod 777 $$LOCAL_REPO_DIR
        cd $$LOCAL_REPO_DIR
        rsync -a --delete --exclude=env --exclude='run_server.sh' --exclude='build/*' --exclude='build_*' --exclude='models/*' /mnt/llama_cpp_mount/ ./
        git config --global --add safe.directory $$LOCAL_REPO_DIR
        echo "Git revision: $(git rev-parse --short HEAD)"
        mkdir -p ./build_qnn
        rm -rf ./build_qnn/*
        cd ./build_qnn
        set -e
        cmake -H.. -B. -DGGML_QNN=on $$CMAKE_EXTRA_OPTIONS -DANDROID_ABI="$$TARGET_ARCH" -DANDROID_PLATFORM="$$ANDROID_PLATFORM" -DANDROID_NDK="$$ANDROID_NDK_HOME" -DCMAKE_TOOLCHAIN_FILE="$$ANDROID_NDK_HOME/build/cmake/android.toolchain.cmake" -DGGML_QNN_SDK_PATH="$$QNN_SDK_PATH" -DCMAKE_BUILD_TYPE="$$BUILD_TYPE"
        make -j $$(nproc)
        chmod -R u+rw $$OUTPUT_DIR
        rsync -av ./bin/llama-* $$OUTPUT_DIR
        rsync -av ./bin/test-backend-ops $$OUTPUT_DIR
        rsync -av $$QNN_SDK_PATH/lib/aarch64-android/libQnnSystem.so $$OUTPUT_DIR
        rsync -av $$QNN_SDK_PATH/lib/aarch64-android/libQnnCpu.so $$OUTPUT_DIR
        rsync -av $$QNN_SDK_PATH/lib/aarch64-android/libQnnGpu.so $$OUTPUT_DIR
        rsync -av $$QNN_SDK_PATH/lib/aarch64-android/libQnnHtp.so $$OUTPUT_DIR
        rsync -av $$QNN_SDK_PATH/lib/aarch64-android/libQnnHtpNetRunExtensions.so $$OUTPUT_DIR
        rsync -av $$QNN_SDK_PATH/lib/aarch64-android/libQnnHtpPrepare.so $$OUTPUT_DIR
        rsync -av $$QNN_SDK_PATH/lib/aarch64-android/libQnnHtp*Stub.so $$OUTPUT_DIR
        rsync -av $$QNN_SDK_PATH/lib/hexagon-*/unsigned/libQnnHtp*Skel.so $$OUTPUT_DIR
        rsync -av $$ANDROID_NDK_HOME/prebuilt/android-arm64/gdbserver/gdbserver $$OUTPUT_DIR
        chown -R "$$HOST_USER_ID" "$$OUTPUT_DIR"
    restart: "no"